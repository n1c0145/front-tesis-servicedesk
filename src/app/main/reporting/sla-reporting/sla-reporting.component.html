<app-loading [loading]="isLoading"></app-loading>

<div style="padding: 24px; max-width: 1200px; margin: 0 auto;">
  <mat-card style="margin-bottom: 24px;">
    <mat-card-header>
      <mat-card-title>Reporte SLA</mat-card-title>
      <mat-card-subtitle>Selecciona un proyecto para generar el reporte</mat-card-subtitle>
    </mat-card-header>
    
    <mat-card-content style="padding: 24px;">
      <mat-form-field appearance="fill" style="width: 100%; margin-bottom: 20px;">
        <mat-label>Por favor selecciona un proyecto</mat-label>
        <mat-select [(ngModel)]="selectedProjectId" (selectionChange)="onProjectSelect()">
          <mat-option [value]="null" disabled>Selecciona un proyecto</mat-option>
          <mat-option *ngFor="let project of projects" [value]="project.id">
            {{ project.nombre }}
          </mat-option>
        </mat-select>
      </mat-form-field>

      <mat-accordion>
        <mat-expansion-panel>
          <mat-expansion-panel-header>
            <mat-panel-title>Filtro de fechas</mat-panel-title>
          </mat-expansion-panel-header>
          
          <mat-form-field appearance="outline" style="width: 100%; margin-bottom: 16px;">
            <mat-label>Rango de fechas</mat-label>
            <mat-date-range-input [rangePicker]="picker">
              <input matStartDate placeholder="Desde" [(ngModel)]="dateRange.start" name="startDate" />
              <input matEndDate placeholder="Hasta" [(ngModel)]="dateRange.end" name="endDate" />
            </mat-date-range-input>
            <mat-datepicker-toggle matSuffix [for]="picker"></mat-datepicker-toggle>
            <mat-date-range-picker #picker></mat-date-range-picker>
          </mat-form-field>

          <div style="display: flex; gap: 12px;">
            <button mat-raised-button color="primary" (click)="applyDateFilters()" [disabled]="isLoadingReport">
              Aplicar fechas
            </button>
            <button mat-stroked-button color="warn" (click)="clearDates()" [disabled]="isLoadingReport">
              Borrar fechas
            </button>
          </div>
        </mat-expansion-panel>
      </mat-accordion>

      <app-loading [loading]="isLoadingReport"></app-loading>
    </mat-card-content>
  </mat-card>

  <div *ngIf="reportData">
    <mat-card style="margin-bottom: 24px;">
      <mat-card-header>
        <mat-card-title>
          {{ reportData.report_parameters?.project_name || 'Proyecto' }}
        </mat-card-title>
        <mat-card-subtitle>
          <div *ngIf="reportData.report_parameters?.date_from && reportData.report_parameters?.date_to">
            Período: {{ reportData.report_parameters.date_from }} - {{ reportData.report_parameters.date_to }}
          </div>
          <div *ngIf="!reportData.report_parameters?.date_from || !reportData.report_parameters?.date_to">
            Reporte completo (sin filtro de fechas)
          </div>
          <div>Generado: {{ reportData.report_parameters?.generated_at | date:'medium' }}</div>
        </mat-card-subtitle>
      </mat-card-header>
    </mat-card>

    <div *ngIf="hasRule('firstresponse_minutes') || hasRule('maxresolution_days') || 
                hasRule('effectivetime_hours') || hasRule('hoursbank_hours')"
         style="margin-bottom: 24px;">
      <mat-card>
        <mat-card-header>
          <mat-card-title>Reglas contratadas</mat-card-title>
        </mat-card-header>
        <mat-card-content style="padding: 24px;">
          <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px;">
            <div *ngIf="hasRule('firstresponse_minutes')">
              <h4 style="margin: 0 0 8px 0; color: #666;">Primera respuesta</h4>
              <p style="margin: 0; font-size: 18px; font-weight: 500;">
                {{ reportData.report_parameters.sla_rules.firstresponse_minutes }} min
              </p>
            </div>
            <div *ngIf="hasRule('maxresolution_days')">
              <h4 style="margin: 0 0 8px 0; color: #666;">Resolución máxima</h4>
              <p style="margin: 0; font-size: 18px; font-weight: 500;">
                {{ reportData.report_parameters.sla_rules.maxresolution_days }} días
              </p>
            </div>
            <div *ngIf="hasRule('effectivetime_hours')">
              <h4 style="margin: 0 0 8px 0; color: #666;">Tiempo efectivo</h4>
              <p style="margin: 0; font-size: 18px; font-weight: 500;">
                {{ reportData.report_parameters.sla_rules.effectivetime_hours }} hrs
              </p>
            </div>
            <div *ngIf="hasRule('hoursbank_hours')">
              <h4 style="margin: 0 0 8px 0; color: #666;">Bolsa de horas</h4>
              <p style="margin: 0; font-size: 18px; font-weight: 500;">
                {{ reportData.report_parameters.sla_rules.hoursbank_hours }} hrs
              </p>
            </div>
          </div>
        </mat-card-content>
      </mat-card>
    </div>

    <mat-card style="margin-bottom: 24px;">
      <mat-card-header>
        <mat-card-title>Resumen de tickets</mat-card-title>
      </mat-card-header>
      <mat-card-content style="padding: 24px;">
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 16px;">
          <div style="text-align: center;">
            <h3 style="margin: 0 0 8px 0; color: #666;">Total tickets</h3>
            <p style="margin: 0; font-size: 24px; font-weight: 500;">
              {{ reportData.tickets_summary?.total_tickets || 0 }}
            </p>
          </div>
          <div style="text-align: center;">
            <h3 style="margin: 0 0 8px 0; color: #666;">Con SLA</h3>
            <p style="margin: 0; font-size: 24px; font-weight: 500;">
              {{ reportData.tickets_summary?.tickets_with_sla || 0 }}
            </p>
          </div>
          <div style="text-align: center;">
            <h3 style="margin: 0 0 8px 0; color: #666;">Sin SLA</h3>
            <p style="margin: 0; font-size: 24px; font-weight: 500;">
              {{ reportData.tickets_summary?.tickets_without_sla || 0 }}
            </p>
          </div>
        </div>
      </mat-card-content>
    </mat-card>

    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 24px; margin-bottom: 24px;">
      <mat-card *ngIf="hasMetric('first_response')">
        <mat-card-header>
          <mat-card-title>Primera respuesta</mat-card-title>
        </mat-card-header>
        <mat-card-content style="padding: 24px;">
          <div style="text-align: center;">
            <p style="font-size: 32px; font-weight: 500; margin: 0 0 8px 0;">
              {{ formatPercentage(reportData.sla_metrics.first_response.compliance_percentage) }}
            </p>
            <p style="color: #666; margin: 0 0 16px 0;">
              Cumplimiento: {{ reportData.sla_metrics.first_response.compliant || 0 }}/{{ reportData.sla_metrics.first_response.total_analyzed || 0 }}
            </p>
            <mat-progress-bar mode="determinate" 
              [value]="reportData.sla_metrics.first_response.compliance_percentage || 0"
              [color]="(reportData.sla_metrics.first_response.compliance_percentage || 0) >= 80 ? 'primary' : 'warn'">
            </mat-progress-bar>
          </div>
        </mat-card-content>
      </mat-card>

      <mat-card *ngIf="hasMetric('max_resolution')">
        <mat-card-header>
          <mat-card-title>Resolución máxima</mat-card-title>
        </mat-card-header>
        <mat-card-content style="padding: 24px;">
          <div style="text-align: center;">
            <p style="font-size: 32px; font-weight: 500; margin: 0 0 8px 0;">
              {{ formatPercentage(reportData.sla_metrics.max_resolution.compliance_percentage) }}
            </p>
            <p style="color: #666; margin: 0 0 16px 0;">
              Cumplimiento: {{ reportData.sla_metrics.max_resolution.compliant || 0 }}/{{ reportData.sla_metrics.max_resolution.total_analyzed || 0 }}
            </p>
            <mat-progress-bar mode="determinate" 
              [value]="reportData.sla_metrics.max_resolution.compliance_percentage || 0"
              [color]="(reportData.sla_metrics.max_resolution.compliance_percentage || 0) >= 80 ? 'primary' : 'warn'">
            </mat-progress-bar>
          </div>
        </mat-card-content>
      </mat-card>

      <mat-card *ngIf="hasMetric('effective_time')">
        <mat-card-header>
          <mat-card-title>Tiempo efectivo</mat-card-title>
        </mat-card-header>
        <mat-card-content style="padding: 24px;">
          <div style="text-align: center;">
            <p style="font-size: 32px; font-weight: 500; margin: 0 0 8px 0;">
              {{ formatPercentage(reportData.sla_metrics.effective_time.compliance_percentage) }}
            </p>
            <p style="color: #666; margin: 0 0 16px 0;">
              Cumplimiento: {{ reportData.sla_metrics.effective_time.compliant || 0 }}/{{ reportData.sla_metrics.effective_time.total_analyzed || 0 }}
            </p>
            <mat-progress-bar mode="determinate" 
              [value]="reportData.sla_metrics.effective_time.compliance_percentage || 0"
              [color]="(reportData.sla_metrics.effective_time.compliance_percentage || 0) >= 80 ? 'primary' : 'warn'">
            </mat-progress-bar>
          </div>
        </mat-card-content>
      </mat-card>
    </div>

    <mat-card *ngIf="hasMetric('hours_bank') && reportData.sla_metrics.hours_bank.hours_contracted != null">
      <mat-card-header>
        <mat-card-title>Bolsa de horas</mat-card-title>
      </mat-card-header>
      <mat-card-content style="padding: 24px;">
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px;">
          <div>
            <h4 style="margin: 0 0 8px 0; color: #666;">Horas usadas</h4>
            <p style="margin: 0; font-size: 20px; font-weight: 500;">
              {{ reportData.sla_metrics.hours_bank.total_hours_used || 0 }} hrs
            </p>
          </div>
          <div>
            <h4 style="margin: 0 0 8px 0; color: #666;">Horas contratadas</h4>
            <p style="margin: 0; font-size: 20px; font-weight: 500;">
              {{ reportData.sla_metrics.hours_bank.hours_contracted || 0 }} hrs
            </p>
          </div>
          <div>
            <h4 style="margin: 0 0 8px 0; color: #666;">Horas restantes</h4>
            <p style="margin: 0; font-size: 20px; font-weight: 500;"
               [style.color]="getStatusColor(reportData.sla_metrics.hours_bank.status)">
              {{ reportData.sla_metrics.hours_bank.hours_remaining || 0 }} hrs
            </p>
          </div>
          <div>
            <h4 style="margin: 0 0 8px 0; color: #666;">Utilización</h4>
            <p style="margin: 0; font-size: 20px; font-weight: 500;">
              {{ formatPercentage(reportData.sla_metrics.hours_bank.utilization_percentage) }}
            </p>
          </div>
        </div>
        <mat-progress-bar mode="determinate" 
          [value]="reportData.sla_metrics.hours_bank.utilization_percentage || 0"
          [color]="(reportData.sla_metrics.hours_bank.utilization_percentage || 0) <= 80 ? 'primary' : 'warn'"
          style="margin-top: 16px;">
        </mat-progress-bar>
      </mat-card-content>
    </mat-card>
  </div>
</div>